name: Create, Auto-Merge Pull Request

on:
  workflow_dispatch:
    inputs:
      commit_message:
        description: 'Commit message'
        required: true
        default: 'Update files'
      auto_merge:
        description: 'Auto-merge the PR'
        type: boolean
        required: true
        default: true

# Note: For this workflow to create pull requests, you need to either:
# 1. Use a Personal Access Token (PAT) with repo scope instead of GITHUB_TOKEN
# 2. Enable "Allow GitHub Actions to create and approve pull requests" in repository settings
#    (Settings > Actions > General > Workflow permissions)
#
# Note: We're using admin merge (--admin flag) to bypass the need for approval since
# GitHub doesn't allow a token to approve its own PRs, which would cause
# "Error: Unprocessable Entity: Review Cannot approve your own pull request"
permissions:
  contents: write
  pull-requests: write

jobs:
  create-pr:
    runs-on: ubuntu-latest
    steps:
      - name: Check out repository
        uses: actions/checkout@v4

      - name: Create or update sample file
        run: |
          # Create a timestamp file for demonstration
          echo "Last updated: $(date)" > sample-file.txt
          echo "This is a sample file created by the GitHub Action workflow." >> sample-file.txt
          echo "Random number: $RANDOM" >> sample-file.txt

      - name: Create Pull Request
        id: cpr
        uses: peter-evans/create-pull-request@v7
        with:
          # Using GITHUB_TOKEN by default, but you may need to use a PAT
          # if repository settings don't allow GitHub Actions to create PRs
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: ${{ github.event.inputs.commit_message }}
          branch: "auto-updates-${{ github.run_id }}"
          base: ${{ github.ref_name }}
          # This ensures the branch is deleted after the PR is merged or closed
          delete-branch: true
          title: "Automated PR: ${{ github.event.inputs.commit_message }}"
          body: |
            ## Automated Pull Request
            
            This pull request was automatically created by the GitHub Action workflow to merge changes back into the `${{ github.ref_name }}` branch.
            
            Changes:
            - Created/Updated sample-file.txt with current timestamp
            - Added random data for testing purposes
            
            The workflow can be manually triggered from the Actions tab.
          labels: |
            automated-pr
            test

      - name: Check outputs
        if: ${{ steps.cpr.outputs.pull-request-number }}
        run: |
          echo "Pull Request Number - ${{ steps.cpr.outputs.pull-request-number }}"
          echo "Pull Request URL - ${{ steps.cpr.outputs.pull-request-url }}"
          
      # Skip approval step since it causes "Cannot approve your own PR" error
      # When using the same token for both creating and approving

      - name: Merge PR directly
        if: ${{ github.event.inputs.auto_merge == 'true' && steps.cpr.outputs.pull-request-number }}
        run: |
          # Set PR to auto-merge immediately without requiring approval
          gh pr merge ${{ steps.cpr.outputs.pull-request-number }} --squash --admin
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
